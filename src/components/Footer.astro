---
const WP = (import.meta.env.WP_URL || "").replace(/\/+$/, "");
const IS_DEV = import.meta.env.DEV;

async function getJSON(u) {
  try {
    const r = await fetch(u, { headers: { Accept: "application/json" } });
    const text = await r.text();
    let json = null;
    try {
      json = JSON.parse(text);
    } catch {}
    return { ok: r.ok, status: r.status, url: u, json, text };
  } catch (e) {
    return { ok: false, status: 0, url: u, err: String(e) };
  }
}

function toRelative(url) {
  try {
    const u = new URL(url);
    return u.pathname + u.search + u.hash;
  } catch {
    return url;
  }
}

// --- actif soulign√© : helpers chemin courant
function normalizePath(p = "") {
  if (!p) return "/";
  try {
    const u = new URL(p, "http://x");
    let s = u.pathname || "/";
    if (s.length > 1 && s.endsWith("/")) s = s.slice(0, -1);
    return s;
  } catch {
    return p;
  }
}
const current = normalizePath(Astro.url.pathname);
// ---

const tried = [];
let links = [];
const info = { WP_URL: WP };

if (WP) {
  const u = `${WP}/wp-json/headless/v1/nav?slug=footer-nav&allow_page_list=0`;
  tried.push(u);
  const r = await getJSON(u);
  info.endpoint = {
    ok: r.ok,
    status: r.status,
    len: Array.isArray(r.json) ? r.json.length : 0,
  };
  if (r.ok && Array.isArray(r.json)) {
    links = r.json
      .map((l) => ({
        label: String(l?.label || ""),
        url: String(l?.url || "#"),
        opensInNewTab: !!l?.opensInNewTab,
      }))
      .filter((l) => l.label && l.url);
  }
} else {
  info.error = "WP_URL manquant dans .env";
}

const year = new Date().getFullYear();
const business = {
  name: "St√©phanie Quibel",
  legalName: "St√©phanie Quibel",
  logo: "/favicon.png",
};
---

<footer class="footer" role="contentinfo">
  <!-- CTA -->
  <section class="footer__cta" aria-labelledby="cta-title">
    <div class="container cta">
      <h2 id="cta-title">Un projet en t√™te&nbsp;? On en discute&nbsp;!</h2>
      {
        /*
      <p>
        <a class="btn btn--ghost btn--cta" href="/contact" data-pointer>
          Parler de votre projet
        </a>
      </p>
      */
      }
    </div>
  </section>

  <!-- Grille principale -->
  <div class="container foot">
    <!-- 1) Acc√®s rapides (SEO) -->
    <nav class="footer__anchors footer__col" aria-label="Acc√®s rapides (SEO)">
      <h3 class="footer__section-title">
        <button
          class="footer__toggle"
          type="button"
          aria-expanded="false"
          aria-controls="footer-panel-anchors"
        >
          Acc√®s rapides
        </button>
      </h3>
      <div class="footer__content" id="footer-panel-anchors" hidden>
        <ul class="footer__anchors-list">
          <li><a href="/services#services">Cr√©ation de site WordPress</a></li>
          <li><a href="/services#services">Refonte WordPress</a></li>
          <li><a href="/services#services">Maintenance & mises √† jour</a></li>
          <li>
            <a href="/services#services">Optimisation des performances</a>
          </li>
          <li><a href="/services#services-cles">Accessibilit√© (RGAA)</a></li>
          <li>
            <a href="/services#services-cles">SEO ‚Äî R√©f√©rencement naturel</a>
          </li>
          <li>
            <a href="/services#developpeuse-wordpress-beziers"
              >D√©veloppeuse WordPress √† B√©ziers</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <!-- 2) Navigation (WP) -->
    <nav class="footer__nav footer__col" aria-label="Navigation">
      <h3 class="footer__section-title">
        <button
          class="footer__toggle"
          type="button"
          aria-expanded="false"
          aria-controls="footer-panel-nav"
        >
          Navigation
        </button>
      </h3>

      <div class="footer__content" id="footer-panel-nav" hidden>
        {
          links.length ? (
            <ul class="footer__list">
              {links.map((l) => {
                const href = toRelative(l.url);
                const norm = normalizePath(href);
                const isActive =
                  norm === "/"
                    ? current === "/"
                    : current === norm || current.startsWith(norm + "/");
                return (
                  <li>
                    <a
                      href={href}
                      aria-current={isActive ? "page" : undefined}
                      class={isActive ? "is-active" : undefined}
                      target={l.opensInNewTab ? "_blank" : undefined}
                      rel={l.opensInNewTab ? "noopener" : undefined}
                    >
                      {l.label}
                    </a>
                  </li>
                );
              })}
            </ul>
          ) : IS_DEV ? (
            <details style="opacity:.85;margin:.25rem 0">
              <summary>Aucun lien de menu re√ßu (DEV)</summary>
              <pre style="max-width:100%;overflow:auto">
                {JSON.stringify({ info, tried }, null, 2)}
              </pre>
            </details>
          ) : null
        }
      </div>
    </nav>

    <!-- 3) Support -->
    <nav class="footer__support footer__col" aria-label="Support">
      <h3 class="footer__section-title">
        <button
          class="footer__toggle"
          type="button"
          aria-expanded="false"
          aria-controls="footer-panel-support"
        >
          Support
        </button>
      </h3>
      <div class="footer__content" id="footer-panel-support" hidden>
        <ul class="footer__list">
          <li><a href="/contact#faq">FAQ</a></li>
          <li><a href="/contact">Contactez-nous</a></li>
        </ul>
      </div>
    </nav>

    <!-- 4) Contact + sociaux -->
    <div class="footer__contact footer__col">
      <h3 class="footer__section-title">
        <button
          class="footer__toggle"
          type="button"
          aria-expanded="true"
          aria-controls="footer-panel-contact"
        >
          Contact
        </button>
      </h3>

      <div class="footer__content" id="footer-panel-contact">
        <ul class="footer__meta">
          <li>
            <a href="mailto:contact@stephaniequibel.fr"
              >contact@stephaniequibel.fr</a
            >
          </li>
          <li>
            <a href="tel:+33620681392">06 20 68 13 92 Lun‚ÄìVen, 9h‚Äì18h</a>
          </li>
          <li><a href="/contact">Formulaire de contact</a></li>
          <li class="zones">B√©ziers ‚Ä¢ Partout en France üá´üá∑</li>
        </ul>

        <div class="footer__contact-bottom">
          <ul class="footer__social">
            <li>
              <a
                href="https://www.linkedin.com/in/stephanie-quibel-developpeuse-web/"
                target="_blank"
                rel="noopener"
                aria-label="LinkedIn"
              >
                <svg
                  width="34"
                  height="34"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    fill="currentColor"
                    d="M4.98 3.5a2.5 2.5 0 11-.02 5.001A2.5 2.5 0 014.98 3.5zM3.5 8.98h2.95V21H3.5V8.98zM9.5 8.98h2.83v1.64h.04c.39-.74 1.35-1.53 2.78-1.53 2.98 0 3.53 1.96 3.53 4.51V21h-2.95v-5.38c0-1.28-.02-2.93-1.79-2.93-1.8 0-2.08 1.41-2.08 2.84V21H9.5V8.98z"
                  ></path>
                </svg>
                <span class="sr-only">LinkedIn</span>
              </a>
            </li>
          </ul>

          <a
            class="footer__brand-bottom"
            href="/"
            aria-label={`${business.name}, retour √† l‚Äôaccueil`}
          >
            <img
              src={business.logo}
              alt=""
              width="34"
              height="34"
              loading="lazy"
              decoding="async"
            />
            <strong>{business.name}</strong>
          </a>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Barre du bas -->
<div class="footer__bottom">
  <div class="container bar">
    <span class="copyright">¬© {year} {business.legalName}</span>
    <a class="backtop btn btn--ghost btn--sm" href="#top">Haut de page ‚Üë</a>
  </div>
</div>
<style is:global>
  /* ===========================
   Footer ‚Äî styles compacts (clean)
   =========================== */

  /* Th√®me clair (d√©faut) */
  :root {
    --footer-bg: #282839;
    --footer-fg: #e9ebf4;
    --footer-muted: #b7bdd1;
    --footer-link: #d7dbff;
    --footer-accent: var(--orange, #ff9900);
    --footer-border: rgba(255, 255, 255, 0.08);
    --footer-halo: color-mix(in oklab, var(--footer-accent) 10%, transparent);
  }

  /* Th√®me sombre (si utilis√©) */
  :root[data-theme="dark"] {
    --footer-bg: #151521;
    --footer-fg: #eef0f6;
    --footer-muted: #3c394cdb;
    --footer-link: #dfe3ff;
    --footer-border: rgba(255, 255, 255, 0.1);
    --footer-halo: color-mix(in oklab, var(--footer-accent) 12%, transparent);
  }

  /* Fond + halo */
  .footer {
    position: relative;
    margin-top: 4rem;
    color: var(--footer-fg);
    background:
      radial-gradient(
        1100px 420px at 70% -10%,
        var(--footer-halo),
        transparent 60%
      ),
      var(--footer-bg);
    border-top: 1px solid var(--footer-border);
  }

  /* Conteneur large (4 colonnes) */
  .footer .container {
    max-width: 1400px;
    margin-inline: auto;
    padding-inline: clamp(16px, 3vw, 28px);
  }

  /* Grille principale (avec espace sous les colonnes) */
  .footer .foot {
    display: grid;
    align-items: start;
    gap: 1.2rem 2rem;
    padding-block: 1.25rem 2.2rem; /* ‚Üê espace sous la grille */
    grid-template-columns:
      minmax(240px, 1.05fr) /* Acc√®s rapides */
      minmax(200px, 0.95fr) /* Navigation */
      minmax(200px, 0.95fr) /* Support */
      minmax(260px, 1fr); /* Contact */
  }

  /* 4 ‚Üí 3 colonnes */
  @media (max-width: 1180px) {
    .footer .foot {
      grid-template-columns:
        minmax(260px, 1.1fr)
        minmax(220px, 0.95fr)
        minmax(250px, 1fr);
    }
  }

  /* 3 ‚Üí 2 colonnes */
  @media (max-width: 980px) {
    .footer .foot {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* 2 ‚Üí 1 colonne */
  @media (max-width: 640px) {
    .footer .foot {
      grid-template-columns: 1fr;
      gap: 1.1rem;
    }
  }

  /* Titres de colonnes (m√™me style) */
  .footer :is(.footer__title, .footer__section-title, .footer__anchors-title) {
    font-size: 1.05rem;
    line-height: 1.2;
    font-weight: 700;
    margin: 0 0 0.55rem;
    color: var(--footer-fg);
  }

  /* Acc√®s rapides (ancres SEO) */
  .footer__anchors-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  /* Listes Nav / Support */
  .footer__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* Liens + soulign√© anim√© */
  .footer a {
    color: var(--footer-link);
    text-decoration: none;
    position: relative;
    transition: color 0.18s ease;
  }
  .footer a::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: -0.2rem;
    height: 2px;
    transform: scaleX(0);
    transform-origin: left;
    background: currentColor;
    opacity: 0.9;
    transition: transform 0.18s ease;
  }
  .footer a:hover::after,
  .footer a:focus-visible::after {
    transform: scaleX(1);
  }
  .footer a.is-active,
  .footer a[aria-current="page"] {
    color: var(--footer-accent);
  }
  .footer a.is-active::after,
  .footer a[aria-current="page"]::after {
    transform: scaleX(1);
    background: var(--footer-accent);
  }

  /* Contact & social */
  .footer__meta {
    list-style: none;
    margin: 0.2rem 0 0.6rem;
    padding: 0;
    display: grid;
    gap: 0.35rem;
    color: var(--footer-link);
  }
  .footer__meta a {
    color: var(--footer-link);
  }
  .footer__meta a:hover {
    text-decoration: underline;
  }
  .footer__meta li {
    color: var(--footer-link);
  }
  .footer__meta .zones {
    color: var(--footer-link);
  }

  /* Colonne Contact en flex pour √©pingler la marque en bas */
  .footer__contact {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  .footer__contact-bottom {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.9rem;
    margin-top: 0.8rem;
    flex-wrap: nowrap;
    width: 100%;
    min-width: 0;
  }

  /* R√©seaux (LinkedIn) */
  .footer__social {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    gap: 0.75rem;
    flex-wrap: nowrap;
  }
  .footer__social a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border-radius: 0.6rem;
    background: color-mix(in oklab, var(--footer-fg) 6%, transparent);
  }
  .footer__social a:hover {
    background: color-mix(in oklab, var(--footer-accent) 18%, transparent);
    color: var(--footer-accent);
  }

  /* Marque en bas √† droite */
  .footer__brand-bottom {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: 0.55rem;
    text-decoration: none;
    color: inherit;
    white-space: nowrap;
    opacity: 0.98;
  }
  .footer__brand-bottom img {
    width: 34px;
    height: 34px;
    border-radius: 0.6rem;
    vertical-align: middle;
  }
  .footer__brand-bottom:hover {
    opacity: 1;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* Lien utilitaire (si utilis√©) */
  .footer__legal {
    margin: 0.6rem 0 0;
    color: var(--footer-muted);
  }
  .footer__legal .sep {
    margin: 0 0.5rem;
    opacity: 0.5;
  }

  /* Barre du bas */
  .footer__bottom {
    border-top: 1px solid var(--footer-border);
  }
  .bar {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 1rem;
    padding: 0.95rem 0;
    padding-bottom: calc(0.95rem + env(safe-area-inset-bottom, 0px));
  }
  .copyright {
    justify-self: center;
    color: var(--footer-muted);
    white-space: nowrap;
  }
  .backtop {
    justify-self: end;
    padding: 0.5rem 0.8rem;
    border-radius: 999px;
    border: 1px solid var(--footer-border);
    background: color-mix(in oklab, var(--footer-fg) 4%, transparent);
    color: var(--footer-link);
  }
  .backtop:hover,
  .backtop:focus-visible {
    filter: brightness(1.04);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* CTA (titre + espace sous le bandeau) */
  .footer__cta .cta {
    padding-block: 1.2rem 2.2rem;
  }

  @media (min-width: 900px) {
    .footer__cta .cta {
      padding-block: 1.4rem 2.6rem;
    }
    .footer__cta :is(h2, #cta-title) {
      font-size: clamp(1.45rem, 2vw + 0.55rem, 2.15rem);
      line-height: 1.15;
      margin: 0 0 0.8rem;
      color: var(--offwithe);
      text-align: left;
    }
  }

  /* Accessibilit√© */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0 0 0 0);
    white-space: nowrap;
    border: 0;
  }

  /* S√©curit√© sur tr√®s petits √©crans */
  @media (max-width: 420px) {
    .footer__contact-bottom {
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 0.6rem 1rem;
    }
    .footer__brand-bottom {
      margin-left: 0;
      order: 2;
    }
    .footer__cta :is(h2, #cta-title) {
      font-size: clamp(1.45rem, 2vw + 0.55rem, 2.15rem);
      line-height: 1.15;
      margin: 0 0 0.8rem;
      color: var(--offwithe);
      text-align: left;
    }
  }

  /* ===== Footer ‚Äî compact mobile (h√©rit√© WP, safe) ===== */
  @media (max-width: 768px) {
    .site-footer {
      padding-block: clamp(16px, 4vw, 24px);
      border-top: 1px solid var(--border);
      background: var(--card);
    }

    .site-footer .footer-grid {
      display: grid;
      grid-template-columns: 1fr !important;
      gap: clamp(10px, 3.5vw, 16px);
    }

    .site-footer h4,
    .site-footer .footer-title {
      font-size: clamp(13px, 3.6vw, 15px);
      line-height: 1.2;
      margin: 0 0 6px;
    }

    .site-footer ul {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 6px;
    }
    .site-footer a {
      font-size: clamp(13px, 3.6vw, 15px);
      line-height: 1.35;
    }

    .site-footer .footer-meta,
    .site-footer address,
    .site-footer .footer-quicklinks {
      font-size: clamp(13px, 3.6vw, 15px);
      line-height: 1.35;
      margin: 0;
    }

    .site-footer .btn,
    .site-footer .wp-block-button__link {
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 10px;
    }

    .site-footer .footer-bottom,
    .site-footer .footnote {
      margin-top: clamp(10px, 3vw, 14px);
      padding-top: clamp(10px, 3vw, 14px);
      border-top: 1px dashed color-mix(in srgb, var(--border) 80%, transparent);
      display: grid;
      gap: 6px;
      text-align: center;
    }
    .site-footer .footer-bottom small,
    .site-footer .footnote small {
      font-size: 12px;
      opacity: 0.8;
    }

    .site-footer .footer-inline,
    .site-footer .legal,
    .site-footer .social {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px 14px;
    }

    .site-footer img,
    .site-footer .logo {
      max-height: 28px;
    }

    .site-footer .wp-block-group,
    .site-footer .wp-block-columns {
      margin: 0 !important;
    }
    .site-footer .wp-block-column + .wp-block-column {
      margin-top: 0 !important;
    }
  }

  /* Boutons d'accord√©on dans le footer */
  .footer__section-title {
    margin: 0 0 0.4rem;
    width: 100%;
  }

  /* Desktop : simple titre, pas de chevron, pas cliquable */
  .footer__toggle {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    color: inherit;
    font: inherit;
    width: 100%;
    text-align: left;
    display: block;
    cursor: default;
  }

  /* Mobile : accord√©on + chevron */
  @media (max-width: 768px) {
    .footer__content[hidden] {
      display: none;
    }

    .footer__col {
      padding-block: 0.4rem 0.6rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .footer__toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .footer__toggle::after {
      content: "‚ñæ";
      font-size: 0.85em;
      margin-left: auto;
      transition: transform 180ms ease;
    }

    .footer__toggle[aria-expanded="true"]::after {
      transform: rotate(180deg);
    }
  }

  :root[data-theme="light"] .copyright {
    color: #111827;
  }

  :root[data-theme="dark"] .copyright {
    color: #e5e7eb;
  }
</style>

<script is:inline>
  (() => {
    const toggles = document.querySelectorAll(".footer__toggle");
    if (!toggles.length) return;

    const mqDesktop = window.matchMedia("(min-width: 768px)");

    function syncMode() {
      const isDesktop = mqDesktop.matches;
      toggles.forEach((btn) => {
        const controls = btn.getAttribute("aria-controls");
        if (!controls) return;
        const panel = document.getElementById(controls);
        if (!panel) return;

        if (isDesktop) {
          // en desktop : toujours ouvert
          btn.setAttribute("aria-expanded", "true");
          panel.hidden = false;
        } else {
          // en mobile : on respecte l'√©tat d√©fini dans le HTML
          if (!panel.hasAttribute("data-init")) {
            const expanded = btn.getAttribute("aria-expanded") === "true";
            panel.hidden = !expanded;
            panel.dataset.init = "1";
          }
        }
      });
    }

    syncMode();
    mqDesktop.addEventListener("change", syncMode);

    toggles.forEach((btn) => {
      const controls = btn.getAttribute("aria-controls");
      if (!controls) return;
      const panel = document.getElementById(controls);
      if (!panel) return;

      btn.addEventListener("click", () => {
        // en desktop : pas d'accord√©on
        if (mqDesktop.matches) return;

        const expanded = btn.getAttribute("aria-expanded") === "true";
        btn.setAttribute("aria-expanded", String(!expanded));
        panel.hidden = expanded;
      });
    });
  })();
</script>
