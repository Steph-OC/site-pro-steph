---
type Link = { label: string; url: string; opensInNewTab?: boolean };

const WP = (import.meta.env.WP_URL || "").replace(/\/+$/, "");

// On tente de lire un tableau depuis l’API headless (ou [] si erreur)
async function getJSON(u: string) {
  try {
    const r = await fetch(u, { headers: { Accept: "application/json" } });
    if (!r.ok) return [] as Link[];
    const j = await r.json();

    // Cas 1 : l’API renvoie directement un tableau
    if (Array.isArray(j)) return j as Link[];

    // Cas 2 : certains endpoints renvoient { json: [...] } ou { items: [...] }
    // → on essaie d’en tirer un tableau
    if (Array.isArray((j as any).json)) return (j as any).json as Link[];
    if (Array.isArray((j as any).items)) return (j as any).items as Link[];

    return [] as Link[];
  } catch {
    return [] as Link[];
  }
}

function toRelative(url: string) {
  try {
    const u = new URL(url);
    return u.pathname + u.search + u.hash;
  } catch {
    return url;
  }
}

function normalizePath(p = "") {
  if (!p) return "/";
  try {
    const u = new URL(p, "http://x");
    let s = u.pathname || "/";
    if (s.length > 1 && s.endsWith("/")) s = s.slice(0, -1);
    return s;
  } catch {
    return p;
  }
}

// slug du menu WP côté headless : adapte si besoin (header-nav / navigation-principale, etc.)
const endpoint = WP
  ? `${WP}/wp-json/headless/v1/nav?slug=header-nav&allow_page_list=1`
  : "";

/** Fallback local, typé correctement */
const fallbackLinks: Link[] = [
  { label: "Accueil", url: "/" },
  { label: "Services", url: "/services/" },
  { label: "Réalisations", url: "/realisations/" },
  { label: "Qui suis-je ?", url: "/a-propos/" },
  { label: "Parlons Web", url: "/parlons-web/" },
  { label: "Contact", url: "/contact/" },
];

// 1) on tente de récupérer le menu WP
const rawLinks = endpoint ? await getJSON(endpoint) : [];

// 2) normalisation des liens
let links: Link[] = (rawLinks as any[])
  .map((l) => ({
    label: String(l?.label || ""),
    url: toRelative(String(l?.url || "#")),
    opensInNewTab: !!l?.opensInNewTab,
  }))
  .filter((l) => l.label && l.url);

// 3) si l’API ne renvoie rien, on prend ton fallback
if (!links.length) {
  links = fallbackLinks;
}

// 4) Patch : forcer le label "Qui suis-je ?" pour /a-propos/
links = links.map((l) => {
  const path = normalizePath(l.url);
  if (path === "/a-propos") {
    return { ...l, label: "Qui suis-je ?" };
  }
  return l;
});

const current = normalizePath(Astro.url.pathname);
const list = links;
---

<ul class="nav">
  {
    list.map((l) => {
      const href = normalizePath(l.url);
      const isActive =
        href === "/"
          ? current === "/"
          : current === href || current.startsWith(href + "/");
      return (
        <li>
          <a
            href={l.url}
            aria-current={isActive ? "page" : undefined}
            target={l.opensInNewTab ? "_blank" : undefined}
            rel={l.opensInNewTab ? "noopener" : undefined}
            class={isActive ? "is-active" : undefined}
          >
            {l.label}
          </a>
        </li>
      );
    })
  }
</ul>

<style>
  .nav {
    display: flex;
    gap: clamp(12px, 2.2vw, 24px);
    list-style: none;
    margin: 0;
    padding: 0;
    align-items: center;
    justify-content: center;
    flex-wrap: nowrap;
    width: max-content; /* la UL mesure son contenu */
    margin-inline: auto; /* et se centre dans .site-nav si besoin */
  }

  .nav li {
    margin: 0;
  }

  .nav a {
    text-decoration: none;
    padding: 0.35rem 0.2rem;
    border-radius: 0.25rem;
    position: relative;
  }

  .nav a::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: -0.2rem;
    height: 2px;
    transform: scaleX(0);
    transform-origin: left;
    background: currentColor;
    opacity: 0.85;
    transition: transform 0.18s ease;
  }

  .nav a:hover::after,
  .nav a:focus-visible::after {
    transform: scaleX(1);
  }

  .nav a.is-active,
  .nav a[aria-current="page"] {
    color: var(--orange, #ff9900);
  }

  .nav a.is-active::after,
  .nav a[aria-current="page"]::after {
    transform: scaleX(1);
    background: var(--orange, #ff9900);
  }
</style>
