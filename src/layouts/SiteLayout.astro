---
/* AUCUN import de wp ici */
const {
  title = "Stéphanie Quibel — Développeuse WordPress",
  description = "",
} = Astro.props;

import HeaderNav from "@/components/HeaderNav.astro";
import Footer from "@/components/Footer.astro";

/* styles globaux */
import "@/styles/base.css";
import "@/styles/layout.css";
import "@/styles/components/header.css";
import "@/styles/components/buttons.css";

/* CSS du pointeur (vanilla) */
import "@/styles/components/pointer-cursor.css";
---

<!doctype html>
<html lang="fr" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@600;700&family=Lato:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="icon" href="/favicon.png" type="image/png" />
    <meta name="theme-color" content="#23212E" />

    <script is:inline>
      // Thème par défaut : sombre, sauf si l’utilisateur a déjà choisi
      (() => {
        const KEY = "theme-pref";
        try {
          const stored = localStorage.getItem(KEY);
          if (stored === "light" || stored === "dark") {
            document.documentElement.dataset.theme = stored;
          } else if (matchMedia("(prefers-color-scheme: dark)").matches) {
            document.documentElement.dataset.theme = "dark";
          } else {
            document.documentElement.dataset.theme = "dark"; // défaut
          }
        } catch {
          document.documentElement.dataset.theme = "dark";
        }
      })();
    </script>
  </head>

  <body>
    <!-- Pointeur iOS-like vanilla (import conditionnel) -->
    <script type="module">
      const canHover = matchMedia("(hover: hover) and (pointer: fine)").matches;
      const reduced = matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (canHover && !reduced) {
        import("/js/pointer-cursor.js")
          .then(({ default: initPointerCursor }) => {
            const root = getComputedStyle(document.documentElement);
            const brand = root.getPropertyValue("--green").trim() || "#5cc7a0";
            initPointerCursor({
              color: brand,
              size: 14,
              radius: 12,
              pad: 8,
              magnetRadius: 56,
              targets:
                "[data-pointer], .post-nav a.btn, .wp-block-button__link, .nav a, a[href], button, [role='button'], .btn",
            });
          })
          .catch(() => {});
      }
    </script>

    <header class="site-header">
      <div class="container nav">
        <a class="brand" href="/">
          <img
            class="brand-logo"
            src="/logo.svg"
            alt="Stéphanie Quibel"
            width="80"
            height="80"
          />
        </a>

        <!-- Bouton burger (mobile) -->
        <button
          id="nav-toggle"
          class="burger"
          type="button"
          aria-label="Ouvrir le menu"
          aria-controls="site-nav"
          aria-expanded="false"
        >
          <span class="burger__box" aria-hidden="true">
            <span class="burger__bar"></span>
          </span>
        </button>

        <!-- Nav principale (rendue par WordPress) -->
        <aside
          id="site-nav"
          class="site-drawer"
          data-state="closed"
          role="dialog"
          aria-modal="true"
          aria-label="Menu principal"
        >
          <HeaderNav />
        </aside>

        <button
          id="theme-toggle"
          class="btn btn--ghost"
          type="button"
          aria-label="Basculer le thème"
          title="Basculer le thème"
        >
          <svg
            class="theme-icon theme-icon--sun"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              d="M12 4V2M12 22v-2M4.93 4.93 3.51 3.51M20.49 20.49l-1.42-1.42M4 12H2m20 0h-2M4.93 19.07l-1.42 1.42M20.49 3.51l-1.42 1.42"
              stroke="currentColor"
              stroke-width="1.5"
              fill="none"
              stroke-linecap="round"></path>
            <circle
              cx="12"
              cy="12"
              r="4"
              stroke="currentColor"
              stroke-width="1.5"
              fill="none"></circle>
          </svg>
          <svg
            class="theme-icon theme-icon--moon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"
              stroke="currentColor"
              stroke-width="1.5"
              fill="none"
              stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Overlay pour fermer en mobile -->
    <button class="nav-overlay" hidden aria-label="Fermer le menu"></button>

    <!-- HERO + contenu principal -->
    <slot name="hero" />
    <main class="container">
      <slot />
    </main>

    <!-- Footer dynamique depuis WordPress -->
    <Footer />

    <script is:inline>
      (function () {
        let t;
        const header = document.querySelector("header.site-header");
        const onScroll = () => {
          if (!header) return;
          clearTimeout(t);
          header.classList.add("scrolling");
          t = setTimeout(() => header.classList.remove("scrolling"), 140);
        };
        addEventListener("scroll", onScroll, { passive: true });

        const setHeaderH = () => {
          if (!header) return;
          document.documentElement.style.setProperty(
            "--header-h",
            header.offsetHeight + "px"
          );
        };
        setHeaderH();
        addEventListener("resize", setHeaderH);

        if (matchMedia("(prefers-reduced-motion: reduce)").matches) {
          document.documentElement.classList.add("reduce-motion");
        } else {
          document.documentElement.classList.remove("reduce-motion");
        }
      })();
    </script>

    <script is:inline>
      (function () {
        const KEY = "theme-pref";
        const btn = document.getElementById("theme-toggle");

        function labelFor(pref) {
          return pref === "dark"
            ? "Activer le thème clair"
            : "Activer le thème sombre";
        }
        function apply(pref) {
          document.documentElement.dataset.theme = pref;
          try {
            localStorage.setItem(KEY, pref);
          } catch {}
          if (btn) {
            btn.setAttribute("aria-pressed", String(pref === "dark"));
            btn.setAttribute("aria-label", labelFor(pref));
            btn.title = labelFor(pref);
          }
        }
        const next = (pref) => (pref === "light" ? "dark" : "light");

        const saved =
          localStorage.getItem(KEY) ||
          document.documentElement.dataset.theme ||
          "dark";
        apply(saved);

        btn?.addEventListener("click", () => {
          const cur = localStorage.getItem(KEY) || saved;
          apply(next(cur));
        });
      })();
    </script>

    <script is:inline>
      (function () {
        const BP = 880; // même breakpoint que le CSS
        const btn = document.getElementById("nav-toggle");
        const panel = document.getElementById("site-nav");
        const overlay = document.querySelector(".nav-overlay");

        if (!btn || !panel || !overlay) return;

        const open = () => {
          panel.dataset.state = "open";
          btn.setAttribute("aria-expanded", "true");
          overlay.hidden = false;
          document.documentElement.classList.add("no-scroll");
        };
        const close = () => {
          panel.dataset.state = "closed";
          btn.setAttribute("aria-expanded", "false");
          overlay.hidden = true;
          document.documentElement.classList.remove("no-scroll");
        };
        const toggle = () =>
          panel.dataset.state === "open" ? close() : open();

        btn.addEventListener("click", toggle);
        overlay.addEventListener("click", close);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") close();
        });

        // Ferme au clic sur un lien
        panel.addEventListener("click", (e) => {
          const t = e.target;
          const link =
            t && typeof t.closest === "function" ? t.closest("a") : null;
          if (link) close();
        });

        // Reset si on repasse desktop (fallback Safari)
        const mq = matchMedia(`(min-width:${BP + 1}px)`);
        const onChange = () => {
          if (mq.matches) close();
        };
        if (mq.addEventListener) mq.addEventListener("change", onChange);
        else if (mq.addListener) mq.addListener(onChange);
      })();
    </script>
  </body>
</html>
