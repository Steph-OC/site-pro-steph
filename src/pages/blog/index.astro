---
import Layout from "@/layouts/SiteLayout.astro";
import HeroBlog from "@/components/HeroBlog.astro";
import * as wp from "@/lib/wp";

import "@/styles/index.css";
import "@/styles/components/blog-hero-bg.css";
import "@/styles/pages/blog.css";

// On tolère l'absence de WP (DEV) → posts = []
let posts: any[] = [];
try {
  const res = await wp.getPosts({ per_page: 12, page: 1 });
  posts = Array.isArray(res) ? res : [];
} catch {
  posts = [];
}
---

<Layout
  title="Parlons web — Blog"
  description="Articles courts sur WordPress, accessibilité, performance et bonnes pratiques."
>
  <HeroBlog
    slot="hero"
    kicker="Parlons web"
    title="Articles & notes"
    lead="Des billets concis sur WordPress, l’accessibilité, la performance et des astuces concrètes."
  />

  {
    posts.length === 0 ? (
      <p style="margin:2rem 0;color:var(--muted)">
        Aucun article pour le moment.
      </p>
    ) : (
      <ul class="posts-grid posts-grid--x3">
        {posts.map((p) => {
          const m = p?._embedded?.["wp:featuredmedia"]?.[0];
          const s = m?.media_details?.sizes || {};
          // fallback de base : viser une taille large pour limiter l’upscale
          const pick = s?.large || s?.medium_large || s?.full || s?.medium || m;
          const src = pick?.source_url || m?.source_url || "";
          const alt =
            m?.alt_text || m?.title?.rendered || p?.title?.rendered || "";
          const titleText = (p?.title?.rendered || "").replace(/<[^>]+>/g, "");

          // srcset trié par largeur croissante
          const entries = Object.values(s || {})
            .filter((x: any) => x?.source_url && x?.width)
            .sort((a: any, b: any) => a.width - b.width) as any[];

          const srcset =
            entries.length > 0
              ? entries
                  .map((x: any) => `${x.source_url} ${x.width}w`)
                  .join(", ")
              : src
                ? `${src} 1600w`
                : "";

          // correspond à la grille 3 → 2 → 1 colonnes
          const sizes = "(min-width:1100px) 32vw, (min-width:640px) 48vw, 92vw";

          // width/height si dispos (meilleur CLS)
          const w = (pick as any)?.width;
          const h = (pick as any)?.height;

          return (
            <li class="card">
              {src && (
                <figure class="card__media" aria-hidden="true">
                  <img
                    src={src}
                    srcset={srcset || undefined}
                    sizes={sizes}
                    alt={alt}
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                    width={w || undefined}
                    height={h || undefined}
                    style="width:100%;height:100%;object-fit:cover;"
                  />
                </figure>
              )}

              <div class="card__body">
                <h3 class="card__title">
                  <span set:html={p.title?.rendered} />
                </h3>

                {p.excerpt?.rendered && (
                  <div class="card__excerpt" set:html={p.excerpt.rendered} />
                )}

                <p class="card__actions">
                  <a
                    class="btn btn--accent"
                    href={`/blog/${p.slug}`}
                    aria-label={`Lire l’article : ${titleText}`}
                  >
                    Lire →
                  </a>
                </p>
              </div>
            </li>
          );
        })}
      </ul>
    )
  }
</Layout>
