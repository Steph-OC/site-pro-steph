---
import SiteLayout from "@/layouts/SiteLayout.astro";
import ApproachStagger from "@/components/ApproachStagger";
import Hero from "@/components/Hero.astro";
import Services from "@/components/Services";
import BadgesMotion from "@/components/BadgesMotion";
import ProjectSlider from "@/components/ProjectSlider";
import { Reveal } from "@/components/Scroll";
import TestimonialsCodepen from "@/components/TestimonialsCodepen";
import "@/styles/index.css";

import { getDerniersProjetsAvecSlides, getTemoignages } from "@/lib/wp";
import { pickFaq } from "@/content/faq";

const miniFaq = pickFaq({ surface: "home", limit: 2 });

const faqJsonLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: miniFaq.map(({ q, a }) => ({
    "@type": "Question",
    name: q,
    acceptedAnswer: { "@type": "Answer", text: a },
  })),
};

const title = "Développeuse WordPress freelance — Stéphanie Quibel";
const description =
  "Sites WordPress rapides, accessibles et bien référencés. Refonte, création, maintenance. Réponse sous 24h.";

/* ---------------------------
   Helpers: map WP/ACF -> UI
   --------------------------- */
const isNonEmpty = (v: any) =>
  v !== undefined && v !== null && String(v).trim() !== "";
const firstOf = (obj: any, keys: string[]) => {
  for (const k of keys) {
    const v = k.includes(".")
      ? k.split(".").reduce((acc, kk) => (acc ? acc[kk] : undefined), obj)
      : obj?.[k];
    if (isNonEmpty(v)) return v;
  }
  return undefined;
};

function buildSlides(acf: any): any[] {
  if (!acf) return [];
  const rows: number[] = [1, 2, 3, 4];
  const slides: any[] = [];

  for (const i of rows) {
    // préférer les champs "list_*" s'ils existent, sinon "slide_*"
    const img = firstOf(acf, [`list_slide_${i}_img`, `slide_${i}_img`]);
    const title = firstOf(acf, [`list_slide_${i}_title`, `slide_${i}_title`]);
    const text = firstOf(acf, [`list_slide_${i}_text`, `slide_${i}_text`]);
    const meta = firstOf(acf, [`list_slide_${i}_meta`, `slide_${i}_meta`]);

    if (
      isNonEmpty(img) ||
      isNonEmpty(title) ||
      isNonEmpty(text) ||
      isNonEmpty(meta)
    ) {
      slides.push({
        img,
        title,
        text,
        meta,
      });
    }
  }
  return slides;
}

function normalizeProjet(raw: any) {
  // si le lib te renvoie déjà le bon shape, ne touche pas
  if (raw?.slides && Array.isArray(raw.slides)) {
    return {
      cardTitle: raw.cardTitle ?? raw.list_card_title ?? raw.card_title,
      cardIntro:
        raw.cardIntro ?? raw.list_card_intro ?? raw.card_intro ?? raw.subtitle,
      subtitle: raw.subtitle,
      slides: raw.slides,
      projet: {
        slug: raw?.projet?.slug ?? raw?.slug,
        siteUrl: raw?.projet?.siteUrl ?? raw?.site_url ?? raw?.acf?.site_url,
      },
    };
  }

  const acf = raw?.acf ?? raw; // certains endpoints mettent tout sous raw.acf
  const cardTitle = firstOf(acf, ["list_card_title", "card_title"]);
  const cardIntro = firstOf(acf, ["list_card_intro", "card_intro", "subtitle"]);
  const accent = firstOf(acf, ["list_card_accent"]); // optionnel
  const siteUrl = firstOf(acf, ["site_url", "slide_url"]); // bouton principal
  const slug = raw?.slug ?? raw?.projet?.slug;

  const slides = buildSlides(acf).map((s: any) => ({
    ...s,
    // si aucune URL de slide spécifique, on se rabattra sur siteUrl au rendu
  }));

  return {
    cardTitle,
    cardIntro,
    accent: accent ?? undefined,
    slides,
    projet: { slug, siteUrl },
  };
}

/* ---------------------------
   Fetch + normalisation
   --------------------------- */
let p1: any = null;
let p2: any = null;

try {
  const data = await getDerniersProjetsAvecSlides(2);
  if (Array.isArray(data)) {
    const n = data.map((d) => normalizeProjet(d)).filter(Boolean);
    p1 = n[0] ?? null;
    p2 = n[1] ?? null;
  } else {
    console.warn("[home] getDerniersProjetsAvecSlides a renvoyé:", typeof data);
  }
} catch (err) {
  console.error("[home] getDerniersProjetsAvecSlides a échoué:", err);
}

/* --- Témoignages --- */
const { items: temoins } = await getTemoignages(10);
const safeTemoins = (temoins ?? []).map((t) => ({
  ...t,
  full_name: (t.full_name ?? t.author ?? "").trim(),
}));
---

<SiteLayout {title} {description}>
  <Fragment slot="hero">
    <Hero
      variant="home"
      bg="glass"
      bleed
      visual="codeReveal"
      kicker="WordPress sur mesure"
      title="Développeuse WordPress — sites rapides & accessibles"
      lead="Je conçois et optimise des sites vitrine & blog qui chargent vite, sont confortables à lire et visibles localement. Réponse sous 24h."
      actions={[
        {
          href: "/realisations/",
          label: "Voir mes réalisations",
          kind: "accent",
        },
        { href: "/contact", label: "Parler de votre projet", kind: "ghost" },
      ]}
    />
  </Fragment>

  <div id="home" class="no-section-bg">
    <!-- Principes -->
    <section
      class="section--halo halo-pulse-gentle"
      aria-labelledby="principes"
    >
      <div class="container container--xl">
        <header class="section-head">
          <h2 id="principes">Principes clés</h2>
          <p class="section-sub">Ce qui guide chaque projet.</p>
        </header>
        <BadgesMotion client:visible />
      </div>
    </section>

    <!-- Services -->
    <section
      class="section--halo halo-pulse-gentle"
      aria-labelledby="services-title"
    >
      <div class="container container--xl">
        <header class="section-head">
          <h2 id="services-title">Mes services</h2>
          <p class="section-sub">Création, refonte, accompagnement.</p>
        </header>
        <Services client:visible />
      </div>
    </section>

    <!-- Derniers projets -->
    <section
      class="section--halo halo-pulse-gentle"
      aria-labelledby="dern-projets"
    >
      <div class="container container--xl">
        <header class="section-head">
          <h2 id="dern-projets">Mes derniers projets</h2>
          <p class="section-sub">
            Deux sites récents, avec leurs fonctionnalités clés.
          </p>
        </header>

        <div class="projects-grid">
          <!-- CARD #1 -->
          <Reveal client:visible direction="left">
            <article class="card project-card">
              <div class="card__body">
                <h3 class="h3">{p1?.cardTitle ?? "Projet récent #1"}</h3>
                <p class="muted">
                  {p1?.cardIntro ?? "Focus sur les fonctionnalités marquantes."}
                </p>
                <ProjectSlider
                  client:visible
                  slides={p1?.slides}
                  accent={p1?.accent ?? "#fd7e14"}
                  siteUrl={p1?.projet?.siteUrl ||
                    p1?.slides?.[0]?.cta?.href ||
                    "#"}
                  detailsUrl={p1?.projet?.slug
                    ? `/realisations/#${p1.projet.slug}`
                    : undefined}
                />
              </div>
            </article>
          </Reveal>

          <!-- CARD #2 -->
          <Reveal client:visible direction="right" delay={0.08}>
            <article class="card project-card">
              <div class="card__body">
                <h3 class="h3">{p2?.cardTitle ?? "Projet récent #2"}</h3>
                <p class="muted">
                  {
                    p2?.cardIntro ??
                      "Navigation fluide, mode sombre et galerie optimisée."
                  }
                </p>
                <ProjectSlider
                  client:visible
                  slides={p2?.slides}
                  accent={p2?.accent ?? "#22b8cf"}
                  siteUrl={p2?.projet?.siteUrl ||
                    p2?.slides?.[0]?.cta?.href ||
                    "#"}
                  detailsUrl={p2?.projet?.slug
                    ? `/realisations/#${p2.projet.slug}`
                    : undefined}
                />
              </div>
            </article>
          </Reveal>
        </div>
      </div>
    </section>

    <!-- Mon approche -->
    <section
      class="section--halo halo-pulse-gentle"
      aria-labelledby="approach-title"
    >
      <div class="container container--xl">
        <ApproachStagger client:visible />
      </div>
    </section>

    <!-- Témoignages -->
    <section
      class="section--halo halo-pulse-gentle"
      aria-labelledby="temoin-title"
    >
      <div class="container container--xl">
        <header class="section-head">
          <h2 id="temoin-title">Collaborations</h2>
          <p class="section-sub">Quelques retours de clients.</p>
        </header>

        {
          safeTemoins.length > 0 ? (
            <TestimonialsCodepen
              items={safeTemoins}
              speedMs={4500}
              avatarMode="initials"
              announceLive={false}
              client:visible
            />
          ) : (
            <p class="muted" style="text-align:center">
              Aucun témoignage…
            </p>
          )
        }
      </div>
    </section>

    <!-- Mini-FAQ -->
    <section
      id="faq"
      class="section--alt section--halo halo-pulse-gentle"
      aria-labelledby="faq-title"
    >
      <div class="container container--narrow">
        <h2 id="faq-title">FAQ</h2>

        {
          miniFaq.map((item) => (
            <details class="faq">
              <summary>{item.q}</summary>
              <p class="faq__answer">{item.a}</p>
            </details>
          ))
        }
        <p class="muted" style="text-align:center;margin-top:var(--space-3)">
          <a href="/services#faq">Voir toutes les questions</a>
        </p>
      </div>
    </section>

    <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />

    <!-- CTA -->
    <section
      class="section--halo halo-pulse-gentle"
      aria-labelledby="cta-title"
    >
      <div class="container container--xl">
        <article class="card">
          <div class="card__body">
            <h2 id="cta-title">Parlons de votre projet</h2>
            <p class="muted">
              Réponse sous 24 h. Vos données ne sont jamais revendues.
            </p>
            <div class="actions">
              <a
                class="btn btn--accent btn--lg cursor-hover-item"
                href="/contact"
                data-cursor-text="CONTACT"
                data-cursor-text-repeat="6">Ouvrir la page Contact</a
              >
              <a
                class="btn btn--ghost cursor-hover-item"
                href="mailto:contact@stephaniequibel.fr"
                data-cursor-text="ÉCRIRE UN E-MAIL"
                data-cursor-text-repeat="5">Écrire un e-mail</a
              >
            </div>
          </div>
        </article>
      </div>
    </section>
  </div>
</SiteLayout>

<!-- JSON-LD -->
<script
  type="application/ld+json"
  set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Organization",
    name: "Stéphanie Quibel",
    url: "https://stephaniequibel.fr/",
    sameAs: ["https://www.linkedin.com"],
    logo: "https://stephaniequibel.fr/logo.png",
  })}
/>

<script
  type="application/ld+json"
  set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    mainEntity: [
      {
        "@type": "Question",
        name: "Combien coûte un site vitrine WordPress ?",
        acceptedAnswer: {
          "@type": "Answer",
          text: "Selon le périmètre, entre 1 500€ et 4 000€ en moyenne. Je fournis un devis détaillé.",
        },
      },
      {
        "@type": "Question",
        name: "Quels délais pour la livraison ?",
        acceptedAnswer: {
          "@type": "Answer",
          text: "De 2 à 6 semaines selon le contenu et les fonctionnalités.",
        },
      },
    ],
  })}
/>
