---
import Layout from "@/layouts/SiteLayout.astro";
import HeroBlog from "@/components/HeroBlog.astro";
import * as wp from "@/lib/wp";
import WPImg from "@/components/WPImg.astro";
import { sizesFullBleed } from "@/lib/img";

import "@/styles/index.css";
import "@/styles/components/blog-hero-bg.css";
import "@/styles/pages/blog.css";
import "@/styles/pages/post.css";

export async function getStaticPaths() {
  const items = await wp.getPosts({ per_page: 50 });
  return (Array.isArray(items) ? items : []).map((p: any) => ({
    params: { slug: p.slug },
  }));
}

const { slug } = Astro.params;

// Article courant
const post = await wp.getPostBySlug(slug!);
if (!post) throw new Error("Article introuvable");

// Image mise en avant
const m = post?._embedded?.["wp:featuredmedia"]?.[0];
const s = m?.media_details?.sizes || {};
const pick = s?.large || s?.medium_large || s?.medium || s?.full || m;
const coverSrc = pick?.source_url || m?.source_url || "";
const coverAlt =
  m?.alt_text || m?.title?.rendered || post?.title?.rendered || "";

// Métadonnées
const dateStr = new Date(post.date).toLocaleDateString("fr-FR", {
  dateStyle: "long",
});
const plain = (post.content?.rendered || "").replace(/<[^>]*>/g, " ");
const words = plain.trim().split(/\s+/).filter(Boolean).length;
const readMin = Math.max(1, Math.round(words / 200));

// Titre/description plain text pour les metas
const plainTitle = (post.title?.rendered || "").replace(/<[^>]+>/g, "");
const plainDesc = (post.excerpt?.rendered || "")
  .replace(/<[^>]+>/g, "")
  .slice(0, 150);

// Précédent / suivant
const all = await wp.getPosts({ per_page: 100 });
const idx = (Array.isArray(all) ? all : []).findIndex(
  (p: any) => p.id === post.id
);
const prev = idx > 0 ? all[idx - 1] : null; // plus récent
const next = idx >= 0 && idx < all.length - 1 ? all[idx + 1] : null; // plus ancien
---

<Layout title={`${plainTitle} — Parlons web`} description={plainDesc}>
  <!-- Hero -->
  <HeroBlog
    slot="hero"
    kicker="Article"
    title={plainTitle}
    lead={`${dateStr} • ${readMin} min de lecture`}
    actions={[{ href: "/blog", label: "Tous les articles", kind: "ghost" }]}
    tags={[
      "WordPress",
      "SEO",
      "Performance",
      "Création",
      "Design",
      "Accessibilité",
    ]}
  />

  <!-- Image de couverture avec parallax doux -->
  {
    coverSrc && (
      <div class="post-cover" style="--h: 58vh">
        <WPImg
          media={m}
          alt={coverAlt}
          sizes={sizesFullBleed}
          fit="cover"
          fetchpriority="high"
          loading="eager"
          variant="abs-cover"
          class="post-cover__img"
        />
      </div>
    )
  }

  <!-- Contenu -->
  <article class="prose" set:html={post.content.rendered} />

  <!-- Navigation précédent / suivant -->
  {
    (prev || next) && (
      <nav class="post-nav" aria-label="Navigation des articles">
        <div>
          {next && (
            <a
              href={`/parlons-web/${next.slug}`}
              class="btn btn--ghost"
              data-pointer
              aria-label={`Article plus ancien : ${(next.title.rendered || "").replace(/<[^>]+>/g, "")}`}
            >
              ← <span set:html={next.title.rendered} />
            </a>
          )}
        </div>
        <div>
          {prev && (
            <a
              href={`/parlons-web/${prev.slug}`}
              class="btn btn--ghost"
              data-pointer
              aria-label={`Article plus récent : ${(prev.title.rendered || "").replace(/<[^>]+>/g, "")}`}
            >
              <span set:html={prev.title.rendered} /> →
            </a>
          )}
        </div>
      </nav>
    )
  }

  <!-- Parallax cover script (doux, perf-friendly, respecte RDM) -->
  <!-- Parallax doux et centré -->
  <script type="module">
    const wrap = document.querySelector(".post-cover");
    if (wrap && matchMedia("(prefers-reduced-motion: no-preference)").matches) {
      const img = wrap.querySelector(".post-cover__img");
      if (img) {
        const AMP = innerWidth >= 900 ? 90 : 40; // intensité
        img.style.setProperty("--pad", `${AMP * 2}px`); // marge anti-bords

        let raf = 0,
          y = 0,
          active = true;

        const io = new IntersectionObserver(
          (entries) => {
            active = entries.some((e) => e.isIntersecting);
            if (active) tick();
            else cancelAnimationFrame(raf);
          },
          { threshold: [0, 1] }
        );
        io.observe(wrap);

        function tick() {
          const r = wrap.getBoundingClientRect();
          const center = r.top + r.height / 2;
          let norm = (innerHeight / 2 - center) / (innerHeight / 2); // -1..1
          norm = Math.max(-1, Math.min(1, norm));
          const target = norm * AMP;

          // lissage
          y += (target - y) * 0.22;
          img.style.setProperty("--y", `${y}px`);

          raf = requestAnimationFrame(tick);
        }
      }
    }
  </script>
</Layout>
