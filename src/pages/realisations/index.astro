---
import SiteLayout from "@/layouts/SiteLayout.astro";
import ListingProjectCard from "@/components/ListingProjectCard";
import "@/styles/pages/realisations.css";
import "@/styles/background.css";
import { Reveal } from "@/components/Scroll";
import {
  getProjectsPage,
  projectSiteUrl,
  listCardTitle,
  listCardIntro,
  listCardAccent,
  toSlidesForListing,
} from "@/lib/wp";

export const prerender = true;

const basePath = "/realisations";

// pagination
const url = new URL(Astro.request.url);
const page = Math.max(1, Number(url.searchParams.get("page") ?? "1") || 1);
const PER_PAGE = 9;

// üîç SEO : titre + description
const baseTitle =
  "R√©alisations WordPress ‚Äî portfolio de sites vitrines & blogs | St√©phanie Quibel";
const title = page > 1 ? `${baseTitle} (page ${page})` : baseTitle;

const description =
  "S√©lection de r√©alisations WordPress : sites vitrines, blogs et pages sur-mesure, con√ßues pour √™tre rapides, accessibles et simples √† faire √©voluer. D√©veloppeuse web freelance pr√®s de B√©ziers, je travaille avec des clientes et clients partout en France.";

// donn√©es WP
const {
  items = [],
  pages = 1,
  total = 0,
} = await getProjectsPage({
  page,
  perPage: PER_PAGE,
});

const cards = await Promise.all(
  items.map(async (p) => ({
    slug: p.slug,
    title: listCardTitle(p) ?? (p.title?.rendered || "Projet"),
    intro: listCardIntro(p) ?? "",
    accent: listCardAccent(p) ?? "#fd3838",
    slides: await toSlidesForListing(p, 4),
    siteUrl: projectSiteUrl(p),
  }))
);

/** Halo vars stables par slug (JS pur) */
function hexToRgbTuple(hex?: string): [number, number, number] | null {
  if (!hex) return null;
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if (!m) return null;
  return [parseInt(m[1], 16), parseInt(m[2], 16), parseInt(m[3], 16)];
}

function haloVarsFromSlug(
  slug: string,
  accent?: string
): Record<string, string> {
  let h = 7;
  for (const ch of slug) h = (h * 31 + ch.charCodeAt(0)) % 100000;

  const hx = 18 + (h % 64);
  const hy = 22 + (Math.floor(h / 97) % 58);
  const sx = 52 + (Math.floor(h / 113) % 18);
  const sy = 44 + (Math.floor(h / 137) % 14);

  let rgbStr = "";
  if (accent && accent.startsWith("#")) {
    const t = hexToRgbTuple(accent);
    if (t) rgbStr = `${t[0]},${t[1]},${t[2]}`;
  } else if (accent && accent.startsWith("rgb")) {
    const m = accent.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if (m) rgbStr = `${m[1]},${m[2]},${m[3]}`;
  }
  if (!rgbStr) {
    const palette = ["255,229,59", "253,56,56", "254,138,57"];
    rgbStr = palette[h % palette.length];
  }
  const alpha = 0.22 + (Math.floor(h / 997) % 16) / 100; // 0.22‚Äì0.38

  return {
    "--halo-x": `${Math.round(hx)}%`,
    "--halo-y": `${Math.round(hy)}%`,
    "--halo-sx": `${Math.round(sx)}%`,
    "--halo-sy": `${Math.round(sy)}%`,
    "--halo-rgba": `rgba(${rgbStr},${alpha.toFixed(2)})`,
  };
}
---

<SiteLayout {title} {description}>
  <main class="halo-desync halo-page realisations realisations-page">
    <!-- HERO avec cube 3D -->
    <section
      class="section--halo halo-pulse-gentle real-hero"
      aria-labelledby="realisations-title"
    >
      <div class="container container--xl real-hero__grid">
        <div class="real-hero__text">
          <p class="kicker">Portfolio</p>
          <h1 id="realisations-title" class="h2">
            R√©alisations WordPress : sites vitrines & blogs
          </h1>
          <p class="section-sub">
            {description}
          </p>
        </div>

        <div class="real-hero__visu" aria-hidden="true">
          <div class="real-hero__cards3d">
            <div class="cards3d__wrapper">
              <div class="cards3d__item" style="--stagger: 3">
                <div class="cards3d__container">
                  <div class="cards3d__card cards3d__card--reflexion">
                    <img
                      class="cards3d__img"
                      src="/images/wirefarmes.webp"
                      alt="R√©flexion : atelier avec croquis et post-its"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                </div>
              </div>

              <div class="cards3d__item" style="--stagger: 2">
                <div class="cards3d__container">
                  <div class="cards3d__card cards3d__card--wireframe">
                    <img
                      class="cards3d__img"
                      src="/images/coder.webp"
                      alt="Wireframe : maquette en noir et blanc d‚Äôune page"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                </div>
              </div>

              <div class="cards3d__item" style="--stagger: 1">
                <div class="cards3d__container">
                  <div class="cards3d__card cards3d__card--site">
                    <img
                      class="cards3d__img"
                      src="/images/site-termine.webp"
                      alt="Site final affich√© sur un √©cran"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <p class="sr-only">
            Illustration des trois √©tapes de r√©alisation : r√©flexion, wireframe
            et site en ligne.
          </p>
        </div>
      </div>
    </section>

    <!-- grille des cartes -->
    <section
      class="section--halo halo-pulse-gentle"
      aria-label="Liste des r√©alisations"
    >
      <div class="container container--xl">
        {
          cards.length === 0 ? (
            <p class="muted">Aucune r√©alisation publi√©e pour le moment.</p>
          ) : (
            <div class="projects-grid">
              {cards.map((c, idx) => (
                <Reveal
                  client:visible
                  direction={idx % 2 === 0 ? "left" : "right"}
                  delay={idx * 0.04}
                >
                  <article
                    id={c.slug}
                    class="card project-card"
                    style={haloVarsFromSlug(c.slug, c.accent)}
                  >
                    <div class="card__body">
                      <h3 class="h3">{c.title}</h3>
                      {c.intro && <p class="muted">{c.intro}</p>}
                      <ListingProjectCard
                        client:visible
                        slides={c.slides}
                        title={c.title}
                        intro={c.intro}
                        accent={c.accent}
                        ctaHref={c.siteUrl || `${basePath}/${c.slug}`}
                        ctaLabel="Voir le site"
                      />
                    </div>
                  </article>
                </Reveal>
              ))}
            </div>
          )
        }
      </div>
    </section>
  </main>

  <!-- SEO -->
  <Fragment slot="head">
    <link
      rel="canonical"
      href={`${Astro.site}${basePath}${page > 1 ? `?page=${page}` : ""}`}
    />

    <!-- JSON-LD ItemList pour la liste de r√©alisations -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "ItemList",
        itemListElement: cards.map((c, idx) => ({
          "@type": "ListItem",
          position: (page - 1) * PER_PAGE + idx + 1,
          url: `${Astro.site}${basePath}/${c.slug}`,
          name: c.title,
        })),
      })}
    />
  </Fragment>
</SiteLayout>
