---
import SiteLayout from "@/layouts/SiteLayout.astro";
import { getServicesPage } from "@/lib/wp";
import { normalizeServices } from "@/lib/services";
import { linesToItems } from "@/helpers/text";
import "@/styles/pages/services.css";
import "@/styles/components/bubbles.css";

const wp = await getServicesPage();
const acf = wp?.acf ?? {};
const data = normalizeServices(acf);

const title = "Services — Stéphanie Quibel";
const description = "Création, refonte, optimisation WordPress.";

// Nettoyage du HTML WordPress (évite <pre><code> dans le hero)
function cleanWpIntro(html: string = "") {
  return (
    html
      // <pre><code>…</code></pre> -> <p>…</p>
      .replace(
        /<pre[^>]*>\s*<code[^>]*>([\s\S]*?)<\/code>\s*<\/pre>/gi,
        "<p>$1</p>"
      )
      // <code>…</code> -> … (texte simple)
      .replace(/<code[^>]*>([\s\S]*?)<\/code>/gi, "$1")
      // trim soft
      .replace(/\s+$/g, "")
  );
}

// On prépare 3 cartes à partir d'ACF si dispo, sinon fallback statique.
const svcFromAcf = (data.services ?? []).slice(0, 3).map((s, i) => ({
  title:
    s.title ||
    [
      "Création sur mesure",
      "Refonte & optimisation",
      "Maintenance & accompagnement",
    ][i] ||
    "Service",
  desc:
    s.desc ||
    [
      "Design fidèle à votre identité, intégration WordPress propre et modulaire. Performance & accessibilité au cœur.",
      "Audit technique & éditorial, UX/UI, nettoyage thème, accélération (LCP/CLS), SEO technique et sécurisation.",
      "Mises à jour, sauvegardes, corrections, petites évolutions et suivi continu des performances & SEO.",
    ][i],
  accent: s.accent || ["#5b98eb", "#ffd166", "#5cc7a0"][i],
}));

// Icônes simples inline (SVG) pour les 3 cartes
const cardIcons = [
  `<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><rect x="3" y="4" width="18" height="12" rx="2" /><path d="M8 20h8" /></svg>`,
  `<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M21 12a9 9 0 1 1-18 0" /><path d="M12 12l6-3" /></svg>`,
  `<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M12 22s8-4 8-10V6l-8-4-8 4v6c0 6 8 10 8 10z" /></svg>`,
];
---

<SiteLayout {title} {description}>
  {/* HERO — Services (2 colonnes) */}
  <Fragment slot="hero">
    <section class="services-hero" aria-labelledby="services-hero-title">
      <div class="container services-hero__grid">
        {/* Colonne texte */}
        <div class="services-hero__col">
          <p class="kicker">WordPress sur mesure</p>
          {
            data.intro.title && (
              <h1 id="services-hero-title">{data.intro.title}</h1>
            )
          }

          {/* ⚠️ utiliser un DIV ici pour accueillir du HTML */}
          {
            data.intro.text && (
              <div class="lead" set:html={cleanWpIntro(data.intro.text)} />
            )
          }

          {
            data.cta?.btnLabel && (
              <div class="actions">
                <a
                  class={`btn btn--${data.cta.style}`}
                  href={data.cta.btnUrl || "/contact"}
                >
                  {data.cta.btnLabel}
                </a>
              </div>
            )
          }
        </div>

        {/* Colonne illu + bulles */}
        <div class="services-hero__illu" aria-hidden="true">
          <svg viewBox="0 0 520 380" fill="none" role="img" aria-hidden="true">
            <defs>
              <filter
                id="s"
                x="0"
                y="0"
                width="520"
                height="380"
                color-interpolation-filters="sRGB"
              >
                <feGaussianBlur stdDeviation="0.6"></feGaussianBlur>
              </filter>
            </defs>

            {/* grille cartes */}
            <g opacity="0.95" filter="url(#s)">
              <rect
                x="40"
                y="32"
                rx="14"
                width="180"
                height="110"
                class="illu-card"></rect>
              <rect
                x="240"
                y="32"
                rx="14"
                width="240"
                height="70"
                class="illu-card"></rect>
              <rect
                x="240"
                y="114"
                rx="14"
                width="150"
                height="28"
                class="illu-chip"></rect>
              <rect
                x="40"
                y="156"
                rx="14"
                width="160"
                height="80"
                class="illu-card"></rect>
              <rect
                x="220"
                y="156"
                rx="14"
                width="260"
                height="160"
                class="illu-card"></rect>
              <rect
                x="40"
                y="252"
                rx="14"
                width="160"
                height="64"
                class="illu-chip"></rect>
            </g>

            {/* petits pictos */}
            <g class="illu-icons">
              <circle cx="96" cy="84" r="14" class="ico ico--a11y"></circle>
              <path d="M96 77v14m-7-7h14" class="ico-stroke"></path>
              <circle cx="290" cy="70" r="14" class="ico ico--perf"></circle>
              <path d="M284 71l6-6 6 12" class="ico-stroke"></path>
              <circle cx="356" cy="201" r="14" class="ico ico--sec"></circle>
              <path d="M350 201h12m-6-6v12" class="ico-stroke"></path>
              <circle cx="120" cy="280" r="14" class="ico ico--seo"></circle>
              <path d="M114 280h12" class="ico-stroke"></path>
            </g>
          </svg>

          {/* Nuage de bulles */}
          <ul class="bubble-cloud" data-active="0" aria-hidden="true">
            <li
              style="--x:12%; --y:22%; --s:1.05; --d:16s; --b:140px; --c:#6aa8ff;"
            >
              WordPress
            </li>
            <li
              style="--x:34%; --y:12%; --s:0.90; --d:18s; --b:110px; --c:#ef9355;"
            >
              Design
            </li>
            <li
              style="--x:56%; --y:28%; --s:1.00; --d:17s; --b:120px; --c:#5cc7a0;"
            >
              SEO
            </li>
            <li
              style="--x:78%; --y:22%; --s:0.95; --d:19s; --b:130px; --c:#b984f6;"
            >
              Maintenance
            </li>
            <li
              style="--x:70%; --y:56%; --s:0.92; --d:21s; --b:115px; --c:#d51111;"
            >
              Sécurité
            </li>
            <li
              style="--x:42%; --y:60%; --s:1.06; --d:17s; --b:130px; --c:#ffd166;"
            >
              Performance
            </li>
          </ul>
        </div>
      </div>

      <div class="services-hero__bg" aria-hidden="true"></div>
    </section>
  </Fragment>

  {/* CONTENU */}
  <div id="services" class="halo-desync">
    {/* 3 cartes services */}
    {
      svcFromAcf.length > 0 && (
        <section class="section--halo svc2" aria-labelledby="services3-title">
          <header class="section-head">
            <h2 id="services3-title">Mes services</h2>
            <p class="muted">
              Trois offres claires, modulables selon vos besoins.
            </p>
          </header>

          <ul class="svc3-cards" role="list">
            {svcFromAcf.map((card, i) => {
              const items = linesToItems(card.desc);
              return (
                <li class="svc3-card" style={`--accent:${card.accent}`}>
                  <div
                    class="svc3-card__icon"
                    aria-hidden="true"
                    set:html={cardIcons[i % cardIcons.length]}
                  />
                  <h3 class="svc3-card__title">{card.title}</h3>

                  {items.length ? (
                    <ul class="svc3-card__list">
                      {items.map((li) => (
                        <li>{li}</li>
                      ))}
                    </ul>
                  ) : (
                    <p class="svc3-card__desc">{card.desc}</p>
                  )}

                  <p class="svc3-card__cta">
                    <a class="btn" href="/contact">
                      {i === 1
                        ? "Demander un audit"
                        : i === 2
                          ? "Demander un devis"
                          : "Parlons de votre projet"}
                    </a>
                  </p>
                </li>
              );
            })}
          </ul>
        </section>
      )
    }

    {/* Étapes */}
    {
      data.steps.length > 0 && (
        <section
          class="container section--halo halo-pulse-gentle"
          aria-labelledby="steps-title"
        >
          <header class="section-head">
            <h2 id="steps-title">Comment ça se passe</h2>
          </header>
          <ol class="steps">
            {data.steps.map((s) => (
              <li>{s}</li>
            ))}
          </ol>
        </section>
      )
    }

    {/* Points clés */}
    {
      (data.tips.cwv || data.tips.access || data.tips.seo) && (
        <section
          class="container section--halo halo-pulse-gentle"
          aria-labelledby="tips-title"
        >
          <header class="section-head">
            <h2 id="tips-title">Points clés</h2>
          </header>
          <ul class="tips" role="list">
            {data.tips.cwv && (
              <li>
                <strong>
                  <abbr title="Core Web Vitals = indicateurs Google sur la vitesse et la stabilité visuelle d’une page.">
                    Core Web Vitals
                  </abbr>
                </strong>
                {" — "}
                {data.tips.cwv}
              </li>
            )}
            {data.tips.access && (
              <li>
                <strong>Accessibilité</strong>
                {" — "}
                {data.tips.access}
              </li>
            )}
            {data.tips.seo && (
              <li>
                <strong>SEO</strong>
                {" — "}
                {data.tips.seo}
              </li>
            )}
          </ul>
        </section>
      )
    }

    {/* FAQ */}
    {
      data.faqs.length > 0 && (
        <section
          class="container section--halo halo-pulse-gentle"
          aria-labelledby="faq-title"
        >
          <header class="section-head">
            <h2 id="faq-title">FAQ</h2>
          </header>
          {data.faqs.map(({ q, a }) => (
            <details class="faq">
              {q && <summary>{q}</summary>}
              {a && <div class="faq__answer" set:html={a} />}
            </details>
          ))}
        </section>
      )
    }

    {/* CTA final */}
    {
      (data.cta.title || data.cta.text || data.cta.btnLabel) && (
        <section class="container section--halo halo-pulse-gentle">
          <article class="card">
            <div class="card__body">
              {data.cta.title && <h2>{data.cta.title}</h2>}
              {data.cta.text && <p class="muted">{data.cta.text}</p>}
              <div class="actions">
                {data.cta.btnLabel && (
                  <a
                    class={`btn btn--${data.cta.style}`}
                    href={data.cta.btnUrl || "/contact"}
                  >
                    {data.cta.btnLabel}
                  </a>
                )}
              </div>
            </div>
          </article>
        </section>
      )
    }
  </div>
</SiteLayout>

<!-- JSON-LD -->
<script
  type="application/ld+json"
  set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ProfessionalService",
    name: "Services WordPress — Stéphanie Quibel",
    areaServed: "France",
    serviceType: ["Création site vitrine", "Refonte", "Maintenance"],
    provider: { "@type": "Person", name: "Stéphanie Quibel" },
  })}
/>

<!-- Interaction des bulles -->
<script type="module">
  import initBubbleCloud from "/src/scripts/bubbles.ts";
  const el = document.querySelector(".services-hero__illu .bubble-cloud");
  if (el) initBubbleCloud(el);
</script>
