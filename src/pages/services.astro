---
import SiteLayout from "@/layouts/SiteLayout.astro";
import { getServicesPage } from "@/lib/wp";
import { normalizeServices } from "@/lib/services";
import { linesToItems } from "@/helpers/text";

import { pickFaq, FAQ_TAGS, type FaqTag } from "@/content/faq";

// CSS page shell
import "@/styles/pages/services/index.css";

// CSS composants
import "@/styles/components/hero-services.css";
import "@/styles/components/svc3-cards.css";
import "@/styles/components/flow-steps.css";
import "@/styles/components/faq.css";
import "@/styles/components/bubbles.css";
import "@/styles/background.css";

const wp = await getServicesPage();
const acf = wp?.acf ?? {};
const data = normalizeServices(acf) ?? {};

// üîç SEO : titre + description un peu plus cibl√©s
const title =
  "Services WordPress ‚Äî cr√©ation, refonte & maintenance √† B√©ziers | St√©phanie Quibel";
const description =
  "Cr√©ation, refonte et optimisation de sites WordPress rapides et bien r√©f√©renc√©s. D√©veloppeuse web freelance pr√®s de B√©ziers (H√©rault), j‚Äôaccompagne vos projets de site vitrine, blog et maintenance partout en France.";

// Nettoyage du HTML WordPress (√©vite <pre><code> dans le hero)
function cleanWpIntro(html: string = "") {
  return html
    .replace(
      /<pre[^>]*>\s*<code[^>]*>([\s\S]*?)<\/code>\s*<\/pre>/gi,
      "<p>$1</p>"
    )
    .replace(/<code[^>]*>([\s\S]*?)<\/code>/gi, "$1")
    .replace(/\s+$/g, "");
}

/** Hex ‚Üí "r g b" (espaces) pour rgb(var(--x) / a) */
function hexToRgbValues(hex?: string): string {
  if (!hex) return "91 152 235"; // fallback bleu
  const h = hex.replace("#", "");
  const s = h.length === 3;
  const r = parseInt(s ? h[0] + h[0] : h.slice(0, 2), 16);
  const g = parseInt(s ? h[1] + h[1] : h.slice(2, 4), 16);
  const b = parseInt(s ? h[2] + h[2] : h.slice(4, 6), 16);
  return `${r} ${g} ${b}`;
}

// ‚úÖ On pr√©pare toujours 3 ‚Äúslots‚Äù de services : soit depuis ACF, soit fallback
const rawServices: any[] =
  Array.isArray(data?.services) && data.services.length
    ? data.services
    : Array.from({ length: 3 }, () => ({}) as any);

// 3 cartes depuis rawServices (ACF ou fallback)
const svcFromAcf = rawServices.slice(0, 3).map((s: any, i: number) => {
  const fallback = ["#2C84DB", "#EE8E48", "#7256C2"][i] ?? "#5b98eb";
  const accent = s?.accent ?? fallback;

  return {
    title:
      s?.title ??
      [
        "Cr√©ation sur mesure",
        "Refonte & optimisation",
        "Maintenance & accompagnement",
      ][i] ??
      "Service",
    desc:
      s?.desc ??
      [
        "Design fid√®le √† votre identit√©, int√©gration WordPress propre et modulaire. Performance & accessibilit√© au c≈ìur.",
        "Audit technique & √©ditorial, UX/UI, nettoyage th√®me, acc√©l√©ration (LCP/CLS), SEO technique et s√©curisation.",
        "Mises √† jour, sauvegardes, corrections, petites √©volutions et suivi continu des performances & SEO.",
      ][i] ??
      "",
    accent,
    accentRgb: hexToRgbValues(accent),
  };
});

function stripHtml(html = "") {
  return html.replace(/<[^>]+>/g, "").trim();
}
const FAQ_THEMES_LABELS: Record<FaqTag, string> = {
  pricing: "Tarifs & budget",
  timeline: "D√©lais & planning",
  process: "Organisation & fa√ßon de travailler",
  maintenance: "Maintenance",
  seo: "Performance & SEO",
  contact: "Prise de contact & localisation",
};

/* Liste FAQ √† afficher ‚Äî TOUTES les questions, sans filtre */
const faqAll = pickFaq(); // pas de surface, pas de excludeTags, pas de limit

/* JSON-LD align√© sur l‚Äôaffichage r√©el */
const faqJsonLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: faqAll.map(({ q, a }) => ({
    "@type": "Question",
    name: q,
    acceptedAnswer: { "@type": "Answer", text: a },
  })),
};

// Ic√¥nes inline (SVG)
const cardIcons = [
  `<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><rect x="3" y="4" width="18" height="12" rx="2" /><path d="M8 20h8" /></svg>`,
  `<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M21 12a9 9 0 1 1-18 0" /><path d="M12 12l6-3" /></svg>`,
  `<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M12 22s8-4 8-10V6l-8-4-8 4v6c0 6 8 10 8 10z" /></svg>`,
];
---

<SiteLayout {title} {description}>
  <!-- HERO ‚Äî Services -->
  <Fragment slot="hero">
    <section class="services-hero" aria-labelledby="services-hero-title">
      <div class="container services-hero__grid">
        <div class="services-hero__col">
          <p class="kicker">WordPress sur mesure</p>
          {
            data?.intro?.title && (
              <h1 id="services-hero-title">{data.intro.title}</h1>
            )
          }
          {
            data?.intro?.text && (
              <div class="lead" set:html={cleanWpIntro(data.intro.text)} />
            )
          }
          {
            data?.cta?.btnLabel && (
              <div class="actions">
                <a
                  class={`btn btn--${data.cta?.style ?? "accent"}`}
                  href={data.cta?.btnUrl || "/contact"}
                >
                  {data.cta.btnLabel}
                </a>
              </div>
            )
          }
        </div>

        <!-- Illu + nuage de bulles -->
        <div class="services-hero__illu" aria-hidden="true">
          <ul class="bubble-cloud" data-active="0" aria-hidden="true">
            <li
              style="--x:12%; --y:22%; --s:1.05; --d:16s; --b:140px; --c:#6aa8ff;"
            >
              WordPress
            </li>
            <li
              style="--x:34%; --y:12%; --s:0.90; --d:18s; --b:110px; --c:#ef9355;"
            >
              Design
            </li>
            <li
              style="--x:56%; --y:28%; --s:1.00; --d:17s; --b:120px; --c:#5cc7a0;"
            >
              SEO
            </li>
            <li
              style="--x:78%; --y:22%; --s:0.95; --d:19s; --b:130px; --c:#b984f6;"
            >
              Maintenance
            </li>
            <li
              style="--x:70%; --y:56%; --s:0.92; --d:21s; --b:115px; --c:#d51111;"
            >
              S√©curit√©
            </li>
            <li
              style="--x:42%; --y:60%; --s:1.06; --d:17s; --b:130px; --c:#ffd166;"
            >
              Performance
            </li>
          </ul>
        </div>
      </div>

      <div class="services-hero__bg" aria-hidden="true"></div>
    </section>
  </Fragment>

  <!-- CONTENU -->
  <div id="services" class="halo-desync">
    <!-- 3 cartes services -->
    {
      svcFromAcf.length > 0 && (
        <section class="section--halo svc3" aria-labelledby="services3-title">
          <header class="section-head">
            <h2 id="services3-title">Mes services</h2>
            <p class="muted">
              Trois offres claires, modulables selon vos besoins.
            </p>
          </header>

          <ul class="svc3-cards" role="list">
            {svcFromAcf.map((card, i) => {
              const items = linesToItems(card.desc ?? "");
              return (
                <li
                  class="svc3-card"
                  style={`--accent:${card.accent}; --accent-rgb:${card.accentRgb}`}
                  data-reveal={i % 2 === 0 ? "fade-up" : "fade-up"}
                  data-reveal-delay={`${0.05 * i}s`}
                >
                  <div class="svc3-card__inner">
                    <div
                      class="svc3-card__icon"
                      aria-hidden="true"
                      set:html={cardIcons[i % cardIcons.length]}
                    />
                    <h3 class="svc3-card__title">{card.title}</h3>

                    {items.length ? (
                      <ul class="svc3-card__list">
                        {items.map((li) => (
                          <li>{li}</li>
                        ))}
                      </ul>
                    ) : (
                      <p class="svc3-card__desc">{card.desc}</p>
                    )}

                    <p class="svc3-card__cta">
                      <a class="btn" href="/contact">
                        {i === 1
                          ? "Demander un audit"
                          : i === 2
                            ? "Demander un devis"
                            : "Parlons de votre projet"}
                      </a>
                    </p>
                  </div>
                </li>
              );
            })}
          </ul>
        </section>
      )
    }

    <!-- √âtapes -->
    {
      (data?.steps?.length ?? 0) > 0 && (
        <section
          class="section--halo"
          aria-labelledby="flow-title"
          data-reveal="fade-right"
        >
          <header class="section-head">
            <h2 id="flow-title">De l‚Äôid√©e au site en ligne</h2>
            <p class="muted">
              Un parcours en 6 √©tapes, transparent et efficace.
            </p>
          </header>

          <div
            class="steps-slider"
            id="steps-slider"
            role="group"
            aria-labelledby="flow-title"
          >
            <label class="step-card">
              <input class="step-input" type="radio" name="flow" checked />
              <span class="step-badge" aria-hidden="true">
                1
              </span>
              <div class="step-info">
                <h3>√âcoute</h3>
                <p class="step-kicker">
                  On clarifie vos objectifs, votre public et le r√¥le de votre
                  site.
                </p>
                <ul class="step-chips" aria-hidden="true">
                  <>
                    <li>√©change</li>
                    <li>1‚Äì2 h</li>
                    <li>en visio</li>
                  </>
                </ul>
              </div>
            </label>

            <label class="step-card">
              <input class="step-input" type="radio" name="flow" />
              <span class="step-badge" aria-hidden="true">
                2
              </span>
              <div class="step-info">
                <h3>Cadrage</h3>
                <p class="step-kicker">
                  On pose l‚Äôarborescence et les priorit√©s, puis on fait √©voluer
                  le site √©tape par √©tape, en ajustant selon vos retours et
                  votre budget.
                </p>
                <ul class="step-chips" aria-hidden="true">
                  <>
                    <li>plan</li>
                    <li>budget</li>
                    <li>fonctionnalit√©s</li>
                  </>
                </ul>
              </div>
            </label>

            <label class="step-card">
              <input class="step-input" type="radio" name="flow" />
              <span class="step-badge" aria-hidden="true">
                3
              </span>
              <div class="step-info">
                <h3>Design</h3>
                <p class="step-kicker">
                  Un site sobre, lisible, pens√© pour le mobile et agr√©able √†
                  consulter par tous¬∑tes.
                </p>
                <ul class="step-chips" aria-hidden="true">
                  <>
                    <li>sobri√©t√©</li>
                    <li>identit√©</li>
                    <li>accessible</li>
                  </>
                </ul>
              </div>
            </label>

            <label class="step-card">
              <input class="step-input" type="radio" name="flow" />
              <span class="step-badge" aria-hidden="true">
                4
              </span>
              <div class="step-info">
                <h3>Int√©gration</h3>
                <p class="step-kicker">
                  Code propre, rapide et accessible, optimis√© pour WordPress et
                  le r√©f√©rencement..
                </p>
                <ul class="step-chips" aria-hidden="true">
                  <>
                    <li>pages modifiables</li>
                    <li>rapide</li>
                    <li>SEO propre</li>
                  </>
                </ul>
              </div>
            </label>

            <label class="step-card">
              <input class="step-input" type="radio" name="flow" />
              <span class="step-badge" aria-hidden="true">
                5
              </span>
              <div class="step-info">
                <h3>Mise en ligne & suivi</h3>
                <p class="step-kicker">
                  D√©ploiement, sauvegardes, s√©curit√© et accompagnement.
                </p>
                <ul class="step-chips" aria-hidden="true">
                  <>
                    <li>mise en ligne</li>
                    <li>sauvegardes</li>
                    <li>suivi</li>
                  </>
                </ul>
              </div>
            </label>

            <label class="step-card">
              <input class="step-input" type="radio" name="flow" />
              <span class="step-badge" aria-hidden="true">
                6
              </span>
              <div class="step-info">
                <h3>Apr√®s</h3>
                <p class="step-kicker">
                  Mises √† jour, corrections et petites √©volutions possibles
                  selon vos besoins.
                </p>
                <ul class="step-chips" aria-hidden="true">
                  <>
                    <li>relecture</li>
                    <li>mobile & ordi</li>
                    <li>corrections</li>
                  </>
                </ul>
              </div>
            </label>
          </div>
        </section>
      )
    }

    <!-- Points cl√©s -->
    {
      (data?.tips?.cwv || data?.tips?.access || data?.tips?.seo) && (
        <section
          id="services-cles"
          class="container section--halo halo-pulse-gentle"
          aria-labelledby="tips-title"
          data-reveal="fade-left"
        >
          <header class="section-head">
            <h2 id="tips-title">Points cl√©s</h2>
          </header>

          <ul class="tips" role="list">
            {data?.tips?.cwv && (
              <li class="tips__item tips__item--cwv">
                <div class="tips__inner">
                  <span class="tips__icon" aria-hidden="true">
                    <svg
                      viewBox="0 0 24 24"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.9"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                    </svg>
                  </span>
                  <p class="tips__text">
                    <strong>
                      <abbr title="Core Web Vitals = indicateurs Google sur la vitesse et la stabilit√© visuelle d‚Äôune page.">
                        Core Web Vitals
                      </abbr>
                    </strong>{" "}
                    ‚Äî {data.tips.cwv}
                  </p>
                </div>
              </li>
            )}

            {data?.tips?.access && (
              <li class="tips__item tips__item--access">
                <div class="tips__inner">
                  <span class="tips__icon" aria-hidden="true">
                    <svg
                      viewBox="0 0 24 24"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.9"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <circle cx="12" cy="4" r="1.7" />
                      <path d="M7 8.5h10" />
                      <path d="M9 21l1.5-8.5" />
                      <path d="M15 21L13.5 12.5" />
                      <path d="M6 11.5l3.5-1.5" />
                      <path d="M18 11.5l-3.5-1.5" />
                    </svg>
                  </span>
                  <p class="tips__text">
                    <strong>Accessibilit√©</strong> ‚Äî {data.tips.access}
                  </p>
                </div>
              </li>
            )}

            {data?.tips?.seo && (
              <li class="tips__item tips__item--seo">
                <div class="tips__inner">
                  <span class="tips__icon" aria-hidden="true">
                    <svg
                      viewBox="0 0 24 24"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.9"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <circle cx="11" cy="11" r="5.5" />
                      <path d="m16 16 4 4" />
                    </svg>
                  </span>
                  <p class="tips__text">
                    <strong>SEO</strong> ‚Äî {data.tips.seo}
                  </p>
                </div>
              </li>
            )}
          </ul>
        </section>
      )
    }

    <!-- FAQ -->
    {
      faqAll.length > 0 && (
        <section
          id="all-faq"
          class="container section--halo halo-pulse-gentle"
          aria-labelledby="faq-title"
          data-reveal="fade-down"
        >
          <header class="section-head">
            <h2 id="faq-title">FAQ</h2>
          </header>

          {faqAll.map(({ q, a }) => (
            <details class="faq">
              <summary>{q}</summary>
              <p class="faq__answer">{a}</p>
            </details>
          ))}
        </section>
      )
    }

    <!-- CTA final -->
    {
      (data?.cta?.title || data?.cta?.text || data?.cta?.btnLabel) && (
        <section class="container section--halo halo-pulse-gentle">
          <article class="card">
            <div class="card__body">
              {data?.cta?.title && <h2>{data.cta.title}</h2>}
              {data?.cta?.text && <p class="muted">{data.cta.text}</p>}
              <div class="actions">
                {data?.cta?.btnLabel && (
                  <a
                    class={`btn btn--${data.cta?.style ?? "accent"}`}
                    href={data.cta?.btnUrl || "/contact"}
                  >
                    {data.cta.btnLabel}
                  </a>
                )}
              </div>
            </div>
          </article>
        </section>
      )
    }
  </div>
</SiteLayout>

<script
  type="application/ld+json"
  set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ProfessionalService",
    "@id": "https://stephaniequibel.fr/services#professional-service",
    name: "Services WordPress ‚Äî St√©phanie Quibel",
    url: "https://stephaniequibel.fr/services",
    image: "https://stephaniequibel.fr/logo.png",
    areaServed: ["B√©ziers", "H√©rault", "Occitanie", "France"],
    serviceType: [
      "Cr√©ation site vitrine WordPress",
      "Refonte de site WordPress",
      "Maintenance WordPress",
      "Optimisation de performance et SEO",
    ],
    provider: {
      "@type": "Person",
      name: "St√©phanie Quibel",
      url: "https://stephaniequibel.fr/",
    },
  })}
/>

<!-- JSON-LD FAQPage align√© avec l‚Äôaffichage -->
<script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />
<!-- Interaction des bulles -->
<script>
  (function () {
    function initBubbleCloud(cloud, opts) {
      // Par d√©faut on limite au conteneur des bulles
      var pointerArea = (opts && opts.pointerArea) || cloud;

      var items = Array.from(cloud.querySelectorAll("li"));
      if (!items.length) return;

      var readVar = function (el, name) {
        var inline = el.getAttribute("style") || "";
        var m = inline.match(new RegExp(name + "\\s*:\\s*([^;]+)"));
        if (m && m[1]) return m[1].trim();
        return getComputedStyle(el).getPropertyValue(name).trim();
      };
      var pct = function (el, name) {
        return parseFloat(readVar(el, name)) || 0;
      };
      var num = function (el, name) {
        return parseFloat(readVar(el, name)) || 0;
      };

      var cloudRect = cloud.getBoundingClientRect();
      var updateRect = function () {
        cloudRect = cloud.getBoundingClientRect();
      };
      window.addEventListener("resize", updateRect);

      var state = items.map(function (el) {
        return {
          el: el,
          xPct: pct(el, "--x"),
          yPct: pct(el, "--y"),
          s: num(el, "--s") || 1,
          b: num(el, "--b") || 120,
          phase: Math.random() * Math.PI * 2,
          speed: 0.6 + Math.random() * 0.6,
          amp: 6 + Math.random() * 10,
          dx: 0,
          dy: 0,
        };
      });

      var mouse = {
        x: cloudRect.width * 0.5,
        y: cloudRect.height * 0.5,
        active: false,
      };
      var toLocalOfCloud = function (e) {
        return {
          x: e.clientX - cloudRect.left,
          y: e.clientY - cloudRect.top,
        };
      };

      pointerArea.addEventListener(
        "pointerenter",
        function (e) {
          mouse.active = true;
          Object.assign(mouse, toLocalOfCloud(e));
        },
        { passive: true }
      );
      pointerArea.addEventListener(
        "pointermove",
        function (e) {
          Object.assign(mouse, toLocalOfCloud(e));
        },
        { passive: true }
      );
      pointerArea.addEventListener("pointerleave", function () {
        mouse.active = false;
      });

      var RADIUS = 130; // px
      var STRENGTH = 80; // force max
      var EASE = 0.18; // lissage

      var last = performance.now();
      var t = 0;
      var tick = function (now) {
        var dt = Math.min(32, now - last) / 1000;
        last = now;
        t += dt;

        for (var i = 0; i < state.length; i++) {
          var b = state[i];
          var cx = (b.xPct / 100) * cloudRect.width;
          var cy = (b.yPct / 100) * cloudRect.height;

          var driftX = Math.sin(b.phase + t * b.speed) * b.amp;
          var driftY = Math.cos(b.phase + t * b.speed * 0.9) * b.amp;

          var repX = 0,
            repY = 0;
          if (mouse.active) {
            var dx = cx - mouse.x;
            var dy = cy - mouse.y;
            var d2 = dx * dx + dy * dy;
            if (d2 > 0) {
              var d = Math.sqrt(d2);
              if (d < RADIUS) {
                var f = 1 - d / RADIUS;
                var s = STRENGTH * f * f;
                repX = (dx / d) * s;
                repY = (dy / d) * s;
              }
            }
          }

          var targetDX = driftX + repX;
          var targetDY = driftY + repY;

          b.dx += (targetDX - b.dx) * EASE;
          b.dy += (targetDY - b.dy) * EASE;

          b.el.style.setProperty("--dx", b.dx.toFixed(2) + "px");
          b.el.style.setProperty("--dy", b.dy.toFixed(2) + "px");
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    // Initialisation sur la page Services
    if (typeof window !== "undefined") {
      window.addEventListener("DOMContentLoaded", function () {
        var el = document.querySelector(".services-hero__illu .bubble-cloud");
        if (el) initBubbleCloud(el);
      });
    }
  })();
</script>
